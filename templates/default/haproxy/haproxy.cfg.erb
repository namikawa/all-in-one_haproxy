global
    log         <%= node['haproxy']['log'] %>
    chroot      <%= node['haproxy']['chroot'] %>
    pidfile     <%= node['haproxy']['pid'] %>
    maxconn     <%= node['haproxy']['maxconn'] %>
    user        <%= node['haproxy']['user'] %>
    group       <%= node['haproxy']['group'] %>
    daemon
    nbproc      <%= node['haproxy']['nbproc'] %>
    stats socket  /var/run/haproxy.sock level user
    stats timeout 10s

defaults
    mode                    <%= node['haproxy']['defaults']['mode'] %>
    log                     global
    retries                 <%= node['haproxy']['defaults']['retries'] %>
    timeout queue           <%= node['haproxy']['defaults']['to_queue'] %>
    timeout connect         <%= node['haproxy']['defaults']['to_connect'] %>
    timeout client          <%= node['haproxy']['defaults']['to_client'] %>
    timeout server          <%= node['haproxy']['defaults']['to_server'] %>
    timeout check           <%= node['haproxy']['defaults']['to_check'] %>

<%- for id, fe in node['haproxy']['frontend'] do %>
frontend <%= fe['name'] %>
    <%- for addr in node['keepalived']['virtual_ipaddress']["#{id}"] do %>
    bind        <%= addr %>:<%= fe['bind_port'] %>
    <%- end %>
    mode        <%= fe['mode'] %>
    default_backend  <%= fe['default_backend'] %>
<%- end %>

<%- for id, be in node['haproxy']['backend'] do %>
backend <%= be['name'] %>
    mode        <%= be['mode'] %>
    balance     <%= be['balance'] %>
    <%- for srvinfo in be['server'] %>
    server <%= srvinfo %>
    <%- end %>
<%- end %>

listen haproxy-stats
    bind        <%= node['haproxy']['stats']['bind'] %>
    mode        http
    maxconn     32
    stats       enable
    stats       show-legends
    stats       uri <%= node['haproxy']['stats']['uri'] %>

