global
    log         <%= node['haproxy']['log'] %>
    chroot      <%= node['haproxy']['chroot'] %>
    pidfile     <%= node['haproxy']['pid'] %>
    maxconn     <%= node['haproxy']['maxconn'] %>
    user        <%= node['haproxy']['user'] %>
    group       <%= node['haproxy']['group'] %>
    daemon
    nbproc      <%= node['haproxy']['nbproc'] %>
    stats socket   <%= node['haproxy']['global']['stats']['socket'] %>
    stats timeout  <%= node['haproxy']['global']['stats']['timeout'] %>

defaults
    mode                    <%= node['haproxy']['defaults']['mode'] %>
    log                     global
    retries                 <%= node['haproxy']['defaults']['retries'] %>
    timeout queue           <%= node['haproxy']['defaults']['to_queue'] %>
    timeout connect         <%= node['haproxy']['defaults']['to_connect'] %>
    timeout client          <%= node['haproxy']['defaults']['to_client'] %>
    timeout server          <%= node['haproxy']['defaults']['to_server'] %>
    timeout check           <%= node['haproxy']['defaults']['to_check'] %>

<%- node['haproxy']['frontend'].each do |id, fe| %>
frontend <%= fe['name'] %>
    <%- node['keepalived']['virtual_ipaddress']["#{id}"].each do |addr| %>
    bind        <%= addr %>:<%= fe['bind_port'] %> <%= fe['bind_option'] %>
    <%- end %>
    mode        <%= fe['mode'] %>
    default_backend  <%= fe['default_backend'] %>
<%- end %>

<%- node['haproxy']['backend'].each do |id, be| %>
backend <%= be['name'] %>
    mode        <%= be['mode'] %>
    balance     <%= be['balance'] %>
    <%- if !be['option'].nil? and be['option'].size != 0 %>
      <%- be['option'].each do |opt| %>
    option      <%= opt %>
      <%- end %>
    <%- end %>
    <%- be['server'].each do |srvinfo| %>
    server <%= srvinfo %>
    <%- end %>
<%- end %>

listen haproxy-stats
    bind        <%= node['haproxy']['stats']['bind'] %>
    mode        http
    maxconn     32
    stats       enable
    stats       show-legends
    stats       uri <%= node['haproxy']['stats']['uri'] %>

